# Nango Integration Guide - Modern Implementation

**Last Updated:** November 3, 2025  
**Nango Version:** 2024+ (Session Token Flow)

---

## üîê Modern Nango Authentication Flow

Nango has **deprecated public keys** in favor of **Connect Session Tokens** for enhanced security.

### Key Changes from Old Flow

| Old (Deprecated) | New (Current) |
|-----------------|---------------|
| Public key in frontend | ‚ùå Removed |
| Manual connection IDs | ‚úÖ Auto-generated by Nango |
| Connection ID from frontend | ‚úÖ Returned via backend webhook |
| `new Nango({ publicKey })` | ‚úÖ `new Nango({ connectSessionToken })` |

---

## üìä Complete Flow Diagram

```
User Action
    ‚Üì
Frontend: Request session token from backend
    ‚Üì
Backend: nango.createConnectSession({ end_user, allowed_integrations })
    ‚Üì
Backend: Return session token to frontend
    ‚Üì
Frontend: new Nango({ connectSessionToken: token })
    ‚Üì
Frontend: Open Connect UI modal
    ‚Üì
User: Authorize integration (Gmail, Slack, etc.)
    ‚Üì
Nango: Generate random connection ID
    ‚Üì
Nango: Send webhook to backend with connection ID
    ‚Üì
Backend: Store connection in database
    ‚Üì
Frontend: Show success message
```

---

## üîß Implementation

### 1. Backend: Create Session Token (Server-Side)

**File:** `apps/web/app/api/integrations/session-token/route.ts`

```typescript
import { nangoServer } from '@/lib/integrations/nango-server';
import { auth, currentUser } from '@clerk/nextjs/server';

export async function POST(req: Request) {
  // 1. Authenticate user
  const { userId } = await auth();
  const user = await currentUser();
  
  if (!userId || !user) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // 2. Get allowed integrations from request
  const { allowedIntegrations } = await req.json();

  // 3. Create Connect Session with Nango
  const session = await nangoServer.createConnectSession({
    end_user: {
      id: userId,
      email: user.emailAddresses[0]?.emailAddress,
      display_name: `${user.firstName} ${user.lastName}`,
    },
    allowed_integrations: allowedIntegrations || [], // Empty = all integrations
  });

  // 4. Return session token to frontend
  return Response.json({ 
    sessionToken: session.token,
    expiresAt: session.expires_at 
  });
}
```

---

### 2. Frontend: Use Session Token

**File:** `apps/web/lib/integrations/nango-client.ts`

```typescript
import Nango from '@nangohq/frontend';

export async function connectIntegration(
  integrationId: string,
  callbacks?: {
    onSuccess?: (connectionId: string) => void;
    onError?: (error: string) => void;
  }
) {
  try {
    // 1. Get session token from backend
    const response = await fetch('/api/integrations/session-token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        allowedIntegrations: [integrationId] 
      }),
    });

    const { sessionToken } = await response.json();

    // 2. Create Nango instance with session token
    const nango = new Nango({ connectSessionToken: sessionToken });

    // 3. Open Connect UI
    const result = await nango.auth(integrationId, {
      // No connection ID needed - Nango generates it
    });

    // 4. Connection ID is sent to backend via webhook
    // Frontend doesn't get it directly anymore
    callbacks?.onSuccess?.(result.connectionId);

  } catch (error) {
    callbacks?.onError?.(error.message);
  }
}
```

---

### 3. Backend: Handle Webhook

**File:** `apps/web/app/api/webhooks/nango/route.ts`

```typescript
export async function POST(req: Request) {
  const payload = await req.json();

  // Nango sends webhook when connection is created
  if (payload.type === 'connection.created') {
    const {
      connection_id,
      provider_config_key, // integration ID
      end_user,
      credentials,
    } = payload;

    // Store connection in your database
    await db.insert(integrations).values({
      id: connection_id,
      workspaceId: end_user.id, // or map to your workspace
      type: provider_config_key,
      status: 'active',
      credentials: encryptCredentials(credentials),
    });

    return Response.json({ received: true });
  }
}
```

---

## üîë Key Security Points

1. **Session tokens are short-lived** (typically 5-10 minutes)
2. **No secrets in frontend** - Only session tokens
3. **Connection IDs auto-generated** - More secure than user-specified
4. **Credentials never exposed to frontend** - Only backend receives them via webhook
5. **End user scoping** - Each session tied to specific user

---

## üì¶ Required Environment Variables

```bash
# Backend only (NEVER expose to frontend)
NANGO_SECRET_KEY=nango_secret_xxxxxxxxxxxxx

# Optional: Self-hosted Nango
NANGO_HOST=https://api.nango.dev
```

---

## üöÄ Migration from Public Key (If Needed)

If you have existing connections using the old public key flow:

### Step 1: Attach users to existing connections

```typescript
import { nangoServer } from '@/lib/integrations/nango-server';

// For each existing connection
await nangoServer.patchConnection(
  {
    connectionId: '<EXISTING-CONNECTION-ID>',
    provider_config_key: '<INTEGRATION-ID>',
  },
  {
    end_user: {
      id: '<USER-ID>',
      email: 'user@example.com',
    },
  }
);
```

### Step 2: Remove public key from frontend

```typescript
// ‚ùå OLD (Remove this)
const nango = new Nango({ publicKey: 'pk_xxxxx' });

// ‚úÖ NEW (Use this)
const nango = new Nango({ connectSessionToken: sessionToken });
```

### Step 3: Update to webhook-based flow

- Set up `/api/webhooks/nango` endpoint
- Configure webhook URL in Nango dashboard
- Update connection creation logic

---

## üìö Resources

- [Nango Migration Guide](https://nango.dev/docs/implementation-guides/migrations/migrate-from-public-key)
- [Connect Session API](https://nango.dev/docs/api-reference/connect-session)
- [Webhooks Documentation](https://nango.dev/docs/webhooks)

---

## ‚úÖ Implementation Checklist

- [ ] Backend endpoint for session token creation
- [ ] Frontend uses session token (not public key)
- [ ] Webhook endpoint configured
- [ ] Environment variables set
- [ ] User mapping configured
- [ ] Public key removed from all frontend code
- [ ] Testing complete for OAuth flow

---

**Status:** Modern Nango implementation ready  
**Security:** Enhanced (no credentials in frontend)  
**Maintenance:** Simplified (auto-generated connection IDs)

